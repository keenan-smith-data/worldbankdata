---
title: "World Debt Stats"
author: "Keenan Smith"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Library Initialize Block, include=FALSE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidymodels))
suppressPackageStartupMessages(library(WDI))
suppressPackageStartupMessages(library(glmnet))
library(nnet)
```


```{r WDI API Pull}
indicator_codes <- c('SI.POV.DDAY','SP.DYN.LE00.IN','SP.POP.TOTL','SP.POP.GROW','SM.POP.NETM','NY.GDP.MKTP.CD','NY.GDP.PCAP.CD','NY.GDP.MKTP.KD.ZG','SL.UEM.TOTL.ZS','FP.CPI.TOTL.ZG','BX.TRF.PWKR.DT.GD.ZS','EN.ATM.CO2E.PC','AG.LND.FRST.ZS','EG.ELC.ACCS.ZS','ER.H2O.FWTL.ZS','EG.ELC.RNWX.ZS','SH.STA.SMSS.ZS','VC.IHR.PSRC.P5','GC.DOD.TOTL.GD.ZS','IT.NET.USER.ZS','SG.GEN.PARL.ZS','BX.KLT.DINV.WD.GD.ZS','SI.POV.GINI','SG.DMK.SRCR.FN.ZS', 'SI.DST.10TH.10', 'SI.DST.FRST.10', 'SP.DYN.TFRT.IN', 'SL.TLF.TOTL.FE.ZS', 'SL.TLF.CACT.MA.ZS', 'SL.TLF.CACT.FE.ZS', 'FB.BNK.CAPA.ZS', 'SP.URB.TOTL.IN.ZS', 'GB.XPD.RSDV.GD.ZS', 'SP.POP.SCIE.RD.P6', 'SP.POP.TECH.RD.P6', 'BX.GSR.ROYL.CD', 'TX.VAL.TECH.CD', 'IP.TMK.RESD', 'IP.TMK.NRES', 'IP.PAT.RESD', 'IP.PAT.NRES')

first_year <- 2010
last_year <- 2022

initial_wdi <- WDI(indicator = indicator_codes, start = first_year, end = last_year, extra = TRUE) |>
  as_tibble()
```


```{r Data Tidy}
# str(initial_WDI)

tidy_wdi <-
  initial_wdi |>
  rename(poverty_headcount = SI.POV.DDAY,
         life_exp = SP.DYN.LE00.IN,
         pop_tot = SP.POP.TOTL,
         pop_grow = SP.POP.GROW,
         migration_net = SM.POP.NETM,
         gdp = NY.GDP.MKTP.CD,
         gdp_per_cap = NY.GDP.PCAP.CD,
         gdp_grow = NY.GDP.MKTP.KD.ZG,
         unemployment = SL.UEM.TOTL.ZS,
         inflation = FP.CPI.TOTL.ZG,
         pers_remit = BX.TRF.PWKR.DT.GD.ZS,
         co2_emis = EN.ATM.CO2E.PC,
         forest_area = AG.LND.FRST.ZS,
         elec_access = EG.ELC.ACCS.ZS,
         water_withdraw = ER.H2O.FWTL.ZS,
         elec_prod_renew = EG.ELC.RNWX.ZS,
         sanitation = SH.STA.SMSS.ZS,
         int_homic = VC.IHR.PSRC.P5,
         gov_debt = GC.DOD.TOTL.GD.ZS,
         internet_use = IT.NET.USER.ZS,
         women_parlia = SG.GEN.PARL.ZS,
         foreign_invest = BX.KLT.DINV.WD.GD.ZS,
         gini = SI.POV.GINI,
         women_decisions = SG.DMK.SRCR.FN.ZS,
         highest_ten = SI.DST.10TH.10,
         lowest_ten = SI.DST.FRST.10,
         fertility_rate = SP.DYN.TFRT.IN,
         labor_force_fe = SL.TLF.TOTL.FE.ZS,
         lab_for_part_m = SL.TLF.CACT.MA.ZS,
         lab_for_part_f = SL.TLF.CACT.FE.ZS,
         bank_cap = FB.BNK.CAPA.ZS,
         urb_pop = SP.URB.TOTL.IN.ZS,
         research_exp = GB.XPD.RSDV.GD.ZS,
         res_in_rd = SP.POP.SCIE.RD.P6,
         tech_in_rd = SP.POP.TECH.RD.P6,
         charge_int_prop = BX.GSR.ROYL.CD,
         hi_tech_exports = TX.VAL.TECH.CD,
         trdmk_res = IP.TMK.RESD,
         trdmk_nres = IP.TMK.NRES,
         pat_res = IP.PAT.RESD,
         pat_nres = IP.PAT.NRES) |>
  mutate(income = as.factor(income),
         region = as.factor(region)) |>
  select(-poverty_headcount, -migration_net, -water_withdraw, -women_decisions,
         -highest_ten, -lowest_ten, -bank_cap, -longitude, -latitude, -lending,
         -iso3c, -capital, -lastupdated, -status, -gov_debt, -gini)


tidy_WDI_2010 <-
  tidy_wdi |>
  filter(year == 2010 & income != "Aggregates" & !is.na(gdp_per_cap)) |>
  select(-country, -year)

tidy_WDI_2015 <-
  tidy_wdi |>
  filter(year == 2015 & income != "Aggregates" & !is.na(gdp_per_cap)) |>
  select(-country, -year)

tidy_WDI_2018 <-
  tidy_wdi |>
  filter(year == 2018 & income != "Aggregates" & income != "Not classified" & !is.na(gdp_per_cap)) |>
  select(-country, -year)

write_csv(tidy_wdi, "tidy_WDI")
write_csv(tidy_WDI_2010, "tidy_WDI_2010")
write_csv(tidy_WDI_2015, "tidy_WDI_2015")
write_csv(tidy_WDI_2018, "tidy_WDI_2018")
```

```{r}
tidy_WDI_2010 |>
  group_by(income) |>
  summarize(num = n(), std_dev = sd(gdp_per_cap, na.rm=TRUE), avg = mean(gdp_per_cap, na.rm=TRUE))

tidy_WDI_2015 |>
  group_by(income) |>
  summarize(num = n(), std_dev = sd(gdp_per_cap, na.rm=TRUE), avg = mean(gdp_per_cap, na.rm=TRUE))

gdp_income_2018 <-
  tidy_WDI_2018 |>
  group_by(income) |>
  summarize(num = n(), std_dev = sd(gdp_per_cap, na.rm=TRUE), avg = mean(gdp_per_cap, na.rm=TRUE))
```

```{r}
lm_fit_1 <- lm(gdp_per_cap ~ income, data = tidy_WDI_2018)
summary(lm_fit_1)
visreg::visreg(lm_fit_1)

lm_fit_2 <- lm(gdp_per_cap ~ region, data = tidy_WDI_2018)
summary(lm_fit_2)
visreg::visreg(lm_fit_2)
```


```{r 2010 Bar Charts}
ggplot(data = tidy_WDI_2010, aes(x = region, y = gdp_per_cap)) +
  geom_col()

ggplot(data = tidy_WDI_2010, aes(x = income, y = gdp_per_cap)) +
  geom_col()

ggplot(data = tidy_WDI_2010, aes(x = region, y = gdp_per_cap)) +
  geom_boxplot()

ggplot(data = tidy_WDI_2010, aes(x = income, y = gdp_per_cap)) +
  geom_boxplot()

tidy_WDI_2018 |>
  filter(income == "High income") |>
  ggplot(aes(x = gdp_per_cap)) +
  geom_histogram()

tidy_WDI_2018 |>
  filter(income == "Low income") |>
  ggplot(aes(x = gdp_per_cap)) +
  geom_histogram()

tidy_WDI_2018 |>
  filter(income == "Lower middle income") |>
  ggplot(aes(x = gdp_per_cap)) +
  geom_histogram()

tidy_WDI_2018 |>
  filter(income == "Upper middle income") |>
  ggplot(aes(x = gdp_per_cap)) +
  geom_histogram()
```



```{r 2018 Bar Charts}
ggplot(data = tidy_WDI_2018, aes(x = region, y = gdp)) +
  geom_col()

ggplot(data = tidy_WDI_2018, aes(x = income, y = gdp)) +
  geom_col()

ggplot(data = tidy_WDI_2018, aes(x = region, y = gdp)) +
  geom_boxplot()

ggplot(data = tidy_WDI_2018, aes(x = income, y = gdp)) +
  geom_boxplot()
```

```{r Model Engines via TidyModels Framework}
# Least Squares Linear Regression
lm_spec <-
  linear_reg() |>
  set_engine("lm") |>
  set_mode("regression")

# Ridge Regression Using Glmnet
ridge_spec <-
  linear_reg(penalty = tune(), mixture = 0) |>
  set_mode("regression") |>
  set_engine("glmnet")

# Lasso Regression Using Glmnet
lasso_spec <-
  linear_reg(penalty = tune(), mixture = 1) |>
  set_mode("regression") |>
  set_engine("glmnet")

# Elastic Net Regression Using Glmnet
elastic_spec <-
  linear_reg(penalty = tune(), mixture = tune()) |>
  set_mode("regression") |>
  set_engine("glmnet")

# Multinomial Regression
multinom_spec <-
  multinom_reg() |>
  set_mode("classification") |>
  set_engine("nnet")
```

```{r}
set.seed(100)

# Splitting Data via Rsample
country_split_2018 <- initial_split(tidy_WDI_2018, strata = income, prop = .8)

country_train_2018 <- training(country_split_2018)
country_test_2018 <- testing(country_split_2018)

country_folds_2018 <- vfold_cv(country_train_2018, v = 10)
```


```{r}
# life_exp + pop_tot + pop_grow + gdp + gdp_per_cap + gdp_grow + unemployment + inflation + pers_remit + co2_emis + forest_area + elec_access + elec_prod_renew + sanitation + int_homic + internet_use + women_parlia + foreign_invest + fertility_rate + labor_force_fe + lab_for_part_m + lab_for_part_f + urb_pop,research_exp + res_in_rd + tech_in_rd + charge_int_prop + hi_tech_exports + trdmk_res + trdmk_nres + pat_res + pat_nres
```


```{r}
income_rec <-
  recipe(income ~ gdp_per_cap, data = country_train_2018)

income_wf <-
  workflow() |>
  add_model(multinom_spec) |>
  add_recipe(income_rec)

income_fit <- fit(income_wf, data = country_train_2018)

model1_tidy <- 
  income_fit |>
  extract_fit_engine()

summary(model1_tidy)
```

